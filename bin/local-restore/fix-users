#!/usr/bin/env node

var options = {
  email: 'test@goodybag.com'
, password: '$2a$10$BMVl2Je.ZhJlfftbKgmt/Onl9247qGPk0f7WN10DFmJRRl8vF1lpC' // password
, concurrency: 10
, skip: [
    'receipts@goodybag.com'
  ]
};

var fs = require('fs');
var async = require('async');
var User = require('../../models').User;

var onError = function( error ){
  throw error;
};

if ( fs.existsSync( __dirname + '/../../local-config.json') ){
  options.email = require('../../local-config.json').testEmail;
}

console.log( "using email:", options.email );

options.email = options.email.split('@');
options.email[0] += '+{id}';
options.email = options.email.join('@');

User.find( { limit: 999999 }, function( error, users ){
  if ( error ) return onError( error );

  var fns = users.map( function( user ){
    return function( done ){
      if ( options.skip.indexOf( user.attributes.email ) > -1 ) return done();

      user.save(
        { values: {
            email: options.email.replace( '{id}', user.attributes.id )
          , password: options.password
          }
        }
      , done
      );
    }
  });

  async.parallelLimit( fns, options.concurrency, function( error ){
    if ( error ) return onError( error );

    console.log( users.length, "users updated!" );
    process.exit(0);
  });
});