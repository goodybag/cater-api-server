{{#extend "css"}}
<link rel="stylesheet" href="/css/order.css">
{{/extend}}

<div class="page page-order container container-small">
  <div class="row">
    <h1 class="col-lg-12 page-title">Review Your Order</h1>
  </div>

  <div class="alert alert-danger alert-bad-zip{{#unless order.restaurant.is_bad_zip}} hide{{/unless}}">
    This order cannot be delivered to that zip code.
  </div>

  <div class="alert alert-danger alert-bad-delivery-time{{#unless order.restaurant.is_bad_delivery_time}} hide{{/unless}}">
    <p>This order cannot be delivered for that date and time.</p>
    <p>delivery hours: {{{json order.restaurant.delivery_times}}}</p>
  </div>

  <div class="alert alert-danger alert-bad-guests{{#unless order.restaurant.is_bad_guests}} hide{{/unless}}">
    <p>This order cannot be delivered for that many guests.</p>
    <p>max guests: {{order.restaurant.max_guests}}</p>
  </div>

  <div class="alert alert-danger alert-bad-lead-time{{#unless order.restaurant.is_bad_lead_time}} hide{{/unless}}">
    <p>This order cannot be delivered for that many guests without more lead time.</p>
    <p>lead times: {{{json order.restaurant.lead_times}}}</p>
  </div>

  <div class="panel panel-order-details">
    <form id="order-form" class="form-light order-form row">
      <div class="col-sm-7 col-left">
        <div class="panel-body">
          <h2 class="restaurant-name">{{order.restaurant.name}}</h2>
          {{#with order}}
          {{> status_label}}
          {{/with}}
          <div class="date-created">
            Date created:
            <span class="date-created-value">{{formatDateTime order.created_at "MMMM Do YYYY, h:mm a"}}</span>
          </div>

          <fieldset class="left-fields">
            <div class="row date-time-guests">
              <div class="form-group col-sm-4" data-icon="gb-icon-calendar">
                <label class="control-label" for="order-date">Delivery Date</label>
                <input type="text" class="form-control order-datetime" id="order-date" value="{{#if order.datetime}}{{formatDateTime order.datetime}}{{else}}{{formatDateTime orderParams.date}}{{/if}}"{{#unless order.editable}} disabled="disabled"{{/unless}}>
              </div>
              <div class="form-group col-sm-4" data-icon="gb-icon-time">
                <label class="control-label" for="order-time">Delivery Time</label>
                <input type="text" class="form-control order-datetime" id="order-time" value="{{#if order.datetime}}{{formatDateTime order.datetime 'hh:mm A'}}{{else}}{{formatTime orderParams.time}}{{/if}}"{{#unless order.editable}} disabled="disabled"{{/unless}}>
              </div>
              <div class="form-group col-sm-4" data-icon="gb-icon-user">
                <label class="control-label" for="order-guests">Guests</label>
                <input type="number" class="form-control" id="order-guests" value="{{#if order.guests}}{{order.guests}}{{else}}{{orderParams.guests}}{{/if}}"{{#unless order.editable}} disabled="disabled"{{/unless}}>
              </div>
            </div>
            <div class="row">
              <div class="form-group col-sm-12">
                <label class="control-label" for="order-notes">Notes</label>
                <textarea id="order-notes" class="form-control order-notes" rows="5"{{#unless order.editable}} disabled="disabled"{{/unless}}>{{order.notes}}</textarea>
              </div>
            </div>
          </fieldset>
        </div>
      </div>
      <div class="col-sm-5 col-right">
        <div class="panel-body">
          <div class="form-inline order-delivery">
            <div class="form-group form-group-block form-group-phone">
              <label class="control-label" for="order-phone label-bold">Phone</label>
              <input type="tel" class="form-control order-phone" id="order-phone" value="{{phoneNumber order.phone}}"{{#unless order.editable}} disabled="disabled"{{/unless}}>
            </div>
            <fieldset class="form-light address-info">
              <legend class="delivery-address-legend">Delivery Address</legend>
              <div class="form-group form-group-block">
                <label class="control-label" for="address-street" class="control-label">Street Address</label>
                <input type="text" id="address-street" class="form-control address-input address-street" value="{{order.street}}"{{#unless order.editable}} disabled="disabled"{{/unless}}>
              </div>
              <div class="form-group form-group-city">
                <label class="control-label" for="address-city">City</label>
                <input type="text" class="form-control" id="address-city" value="{{order.city}}"{{#unless order.editable}} disabled="disabled"{{/unless}}>
              </div>
              <div class="form-group form-group-state">
                <label for="address-state" class="control-label">State</label>
                <select id="address-state" class="form-control address-input address-state" form="order-form"{{#unless order.editable}} disabled="disabled"{{/unless}}>
                  {{#each states}}
                  <option value="{{this.abbr}}" label="{{this.abbr}}"{{#if this.default}} selected="selected"{{/if}}>{{this.name}}</option>
                  {{/each}}
                </select>
              </div>
              <div class="form-group form-group-zip">
                <label class="control-label" for="address-zip">Zip</label>
                <input type="text" class="form-control" id="address-zip" value="{{order.zip}}"{{#unless order.editable}} disabled="disabled"{{/unless}}>
              </div>
            </fieldset>
          </div>
        </div>
      </div>
    </form>
  </div>

  <div class="panel panel-order-line-item">
    {{#unless order.orderItems.length}}
    <div class="panel-heading">No Order Items</div>
    {{else}}
    <div class="panel-heading">Order Summary</div>

    <table class="table order-line-item-table">
      <thead>
        <tr>
          <th class="line-item-name">Item</th>
          <th class="line-item-quantity">Quantity</th>
          <th class="line-item-notes">Notes</th>
          <th class="line-item-price">Price</th>
        </tr>
      </thead>
      <tbody>
        {{#each order.orderItems}}
        <tr id="order-item-{{this.id}}">
          <td class="line-item-name">
            <div class="item-name">{{this.name}}</div>
            {{#if ../order.editable}}<a class="item-remove remove-order-item-btn" href="#">Remove</a>{{/if}}
          </td>
          <td class="line-item-quantity">
            <span class="icon-x">x</span>
            <input type="number" class="item-quantity-input form-control order-item-field order-item-quantity" value="{{this.quantity}}"{{#unless ../order.editable}} disabled="disabled"{{/unless}}>
          </td>
          <td class="line-item-notes">
            <textarea name="notes" class="item-notes-textarea form-control order-item-field order-item-notes"{{#unless ../order.editable}} disabled="disabled"{{/unless}}>{{this.notes}}</textarea>
          </td>
          <td class="line-item-price">{{dollars this.price}}</td>
        </tr>
        {{/each}}
      </tbody>
    </table>
    {{/unless}}

    <div class="panel-body">
      {{#if order.orderItems.length}}
      <div class="row">
        <div class="col-lg-12">
          {{> totals}}
        </div>
      </div>
      {{/if}}

      <div class="row panel-actions">
        <div class="col-lg-6 actions-left">
          <a class="btn btn-add-to-order" href="/restaurants/{{order.restaurant.id}}">Add to Order</a>
        </div>
        <div class="col-lg-6 actions-right">
          {{#if owner}}
            {{#if order.cancelable}}
            <button class="btn btn-cancel">Cancel Order</button>
            {{/if}}
            {{#if order.submittable}}
            <button class="btn btn-primary btn-submit">Submit</button>
            {{/if}}
          {{/if}}
        </div>
      </div>
    </div>
  </div>

  {{#if restaurantReview}}
  <div class="panel restaurant-review">
    <div class="h2 panel-heading">Review</div>
    <div class="panel-body">
      <button class="btn btn-lg btn-danger btn-reject">Reject</button>
      <button class="btn btn-lg btn-success btn-accept">Accept</button>
    </div>
  </div>
  {{/if}}

</div>

{{#extend "scripts"}}
<script src="/js/amanda.js"></script>
<script src="/components/async/lib/async.js"></script>

<script src="/js/models/item.js"></script>
<script src="/js/models/category.js"></script>
<script src="/js/models/restaurant.js"></script>
<script src="/js/models/order-item.js"></script>
<script src="/js/models/order.js"></script>

<script src="/js/collections/items.js"></script>
<script src="/js/collections/categories.js"></script>

<script src="/js/views/form-view.js"></script>
<script src="/js/views/order-view.js"></script>
<script src="/js/views/order-item-view.js"></script>
<script>
  $.get('/partials/totals.hbs', null, function(data, textStatus, jqXHR) {
    Handlebars.registerPartial('totals', Handlebars.compile(data));
  }, 'html')
  var query = window.location.search ? _.object(_.map(window.location.search.substring(1).split('&'), function(obj) { return obj.split('='); })) : {};
  var view = new OrderView( {el: $('#main'), model: new Order( {{{json order}}} ), token: query.token} );
  var items = [
    {{#each order.orderItems}}
    {{#if @index}},{{/if}} new OrderItemView({el: $('#order-item-{{this.id}}'), model: view.model.orderItems.get({{this.id}})})
    {{/each}}
  ];
  view.items = items;
</script>
{{/extend}}
