{{#extend "page"}}page-order{{/extend}}

{{#extend "html-title"}}#{{order.id}}{{/extend}}

{{#extend "body"}}
<div class="container" id="main-container">
  <div class="page-header">
    <ul class="breadcrumbs main-breadcrumbs">
      <li>
        <a href="/admin">Admin Panel</a>
      </li>
      <li>
        <a href="/orders">Orders</a>
      </li>
      <li>Order <a href="/orders/{{order.id}}">#{{order.id}}</a></li>
    </ul>
    <div class="page-title">
      <a href="{{config.baseUrl}}/orders/{{order.id}}?review_token={{order.review_token}}">&lt;&lt; Back to Review Order</a>
      <h2>Order #{{order.id}} Command Center</h2>
      <h4>Scheduled for
        <div class="datetime-picker-group">
          <input type="text" class="datetime-picker" name="delivery-date" value="{{formatDateTime2 order.datetime "ddd MMM DD, YYYY"}}" />
        </div>
        at
        <div class="datetime-picker-group">
          <input type="text" class="datetime-picker" name="delivery-time" value="{{formatDateTime2 order.datetime "h:mm A"}}" />
        </div>
        {{formatDateTimeWithTz order.datetime order.timezone "z"}}
        in {{order.restaurant.region.name}}</h4>
    </div>
  </div>

  {{#if order.alerts.length}}
  <div class="alerts">
    {{#each order.alerts}}
    <div class="alert alert-dismissable alert-{{this.level}}">
      <button type="button" class="close" data-dismiss="alert" aria-hidden="true">Ã—</button>
      {{this.message}}
    </div>
    {{/each}}
  </div>
  {{/if}}

  <div class="dropdown-actions">
    <div class="form-group form-group-inline form-group-save hide">
      <button class="btn btn-primary" role="save">Save Changes</button>
    </div>
    <div class="form-group form-group-inline form-group-save hide">
      <button class="btn btn-default" role="cancel">Cancel</button>
    </div>
  </div>

  {{!-- {{{formatJSON order.restaurant.region}}} --}}

  <div class="panel-section">
    <section class="panel-component" id="internal-notes">
      <h1 class="component-title">Notes</h1>
      <div class="panel-body"></div>
    </section>

    <section class="panel-component" id="order-details">
      <dl class="order-details definition-row-list">
        <div class="row">
          <dt>Restaurant Location</dt>
          <dd>
            <select name="restaurant_location_id" id="order-restaurant_location_id" class="form-control">
              <option value="null"
                {{~#unless this.id}} selected="true"{{/unless}}>None</option>
              {{#each order.restaurant.locations}}
                <option value="{{this.id}}"
                {{~#eq ../order.restaurant_location_id this.id}} selected="true"{{/eq}}>{{../order.restaurant.name}} - {{this.name}}</option>
              {{/each}}
            </select>
          </dd>
        </div>
        <div class="row">
          <dt>Order Type</dt>
          <dd>
            <select name="type" id="order-type" class="form-control">
              <option value="pickup"{{#eq order.type 'pickup'}} selected="true"{{/eq}}>Pickup</option>
              <option value="delivery"{{#eq order.type 'delivery'}} selected="true"{{/eq}}>Delivery</option>
              <option value="courier"{{#eq order.type 'courier'}} selected="true"{{/eq}}>Courier Service</option>
              <option value="pickup silent">Pickup (No Notifications)</option>
              <option value="delivery silent">Delivery (No Notifications)</option>
              <option value="courier silent">Courier Service (No Notifications)</option>
            </select>
            <div class="form-group-courier {{#dneq order.type 'courier'}}hide{{/dneq}}">
              <label for="order-delivery_service_id">Courier</label>
              <select name="delivery_service_id" id="order-delivery_service_id" class="form-control">
                <option value="null"
                  {{~#unless this.id}} selected="true"{{/unless}}>None</option>
                {{#each ../delivery_services}}
                  <option value="{{this.id}}"
                  {{~#eq ../../order.delivery_service_id this.id}} selected="true"{{/eq}}>{{this.name}}</option>
                {{/each}}
              </select>
            </div>
            {{#is order.type 'pickup' 'courier'}}
              <h2 class="title">Pickup Time</h2>
              <span class="details">
                {{formatDateTime2 order.pickup_datetime "ddd MMM DD, YYYY"}} at {{formatDateTime2 order.pickup_datetime "h:mm A"}} {{formatDateTimeWithTz order.pickup_datetime order.timezone "z"}}
              </span>
            {{/is}}
            {{#eq order.type 'courier'}}
              <h2 class="title">Tracking ID</h2>
              <div class="details">
                {{#if order.courier_tracking_id}}
                  <div id="courier-tracking-group">
                    {{{displayWebsite order.courier_tracking_id}}}
                    <i id="edit-courier-tracking" class="gb-icon-pencil"></i>
                  </div>
                {{/if}}
                <input
                  class="{{#if order.courier_tracking_id}}hide{{/if}}"
                  data-autoselect
                  type="text"
                  name="courier_tracking_id"
                  value="{{order.courier_tracking_id}}">
              </div>
              <h2 class="title">Why is this a courier order?</h2>
              <ul class="details">
                {{#if order.courierReasons}}
                {{#each order.courierReasons}}
                  <li>{{> courier_reasoning}}</li>
                {{/each}}
                {{else}}
                  <li>I honestly do not know</li>
                {{/if}}
              </ul>
            {{/eq}}
          </dd>
        </div>
        <div class="row">
          <dt>Order Address</dt>
          <dd>
            <select name="user-address" id="order-user-address" class="form-control">
              <option value="" selected="true">{{{address order}}}</option>
            </select>
          </dd>
        </div>
        <div class="row">
          <dt>Order Status</dt>
          <dd>
            <select name="order_status">
              <option value="pending" {{#eq order.status 'pending'}}selected="true"{{/eq}}>Pending</option>
              <option value="canceled" {{#eq order.status 'canceled'}}selected="true"{{/eq}}>Canceled</option>
              <option value="submitted" {{#eq order.status 'submitted'}}selected="true"{{/eq}}>Submitted</option>
              <option value="denied" {{#eq order.status 'denied'}}selected="true"{{/eq}}>Denied</option>
              <option value="accepted" {{#eq order.status 'accepted'}}selected="true"{{/eq}}>Accepted</option>
              <option value="delivered" {{#eq order.status 'delivered'}}selected="true"{{/eq}}>Delivered</option>
              <option data-silent="true" value="submitted">Submitted - no notification</option>
              <option data-silent="true" value="accepted">Accepted - no notification</option>
              <option data-silent="true" value="canceled">Canceled - no notification</option>
            </select>
          </dd>
        </div>
      </dl>
      <dl class="order-details-delivery definition-row-list">
        <div class="title">
          Delivery Details
        </div>
        <div class="row">
          <dt>Order Notes</dt>
          <dd>
            <textarea name="order-notes" id="order-notes" class="form-control">{{order.notes}}</textarea>
          </dd>
        </div>
        <div class="row">
          <dt>Delivery Instructions</dt>
          <dd>
            <textarea name="order-delivery-instructions" id="order-delivery-instructions" class="form-control">{{order.delivery_instructions}}</textarea>
          </dd>
        </div>
        <div class="row">
          <dt>Actual Delivery Time</dt>
          <dd>
            <div class="actual-dt-row">
              <input
                class="actual-dt-in"
                name="actual-dt-hour"
                type="number"
                {{#if order.actual_delivery_datetime}}
                  value="{{formatDateTime2 order.actual_delivery_datetime "h"}}"
                {{/if}}
                min="1" max="12" />
              <span>:</span>
              <input
                class="actual-dt-in"
                name="actual-dt-min"
                type="number"
                {{#if order.actual_delivery_datetime}}
                  value="{{formatDateTime2 order.actual_delivery_datetime "mm"}}"
                {{/if}}
                min="0" max="59"
                onchange="if(parseInt(this.value,10)<10)this.value='0'+this.value;" />
              <select class="actual-dt-in" name="actual-dt-period">
                <option value="am"{{#eq (getAMPM order.actual_delivery_datetime) 'am'}} selected{{/eq}}>AM</option>
                <option value="pm"{{#eq (getAMPM order.actual_delivery_datetime) 'pm'}} selected{{/eq}}>PM</option>
              </select>
            </div>
          </dd>
        </div>
      </dl>
    </section>
    <section class="panel-component" id="order-summary">
      <dl class="order-payment-summary definition-row-list">
        <div class="title">
          Payment Info
        </div>
        <div class="row">
          <dt>Payment Status</dt>
          <dd>
            <select name="payment_status">
              <option value="" {{#if (not order.payment_status) }}selected="true"{{/if}}>Unprocessed</option>
              <option value="pending" {{#eq order.payment_status 'pending'}}selected="true"{{/eq}}>In-progress</option>
              <option value="paid" {{#eq order.payment_status 'paid'}}selected="true"{{/eq}}>Paid</option>
              <option value="invoiced" {{#eq order.payment_status 'invoiced'}}selected="true"{{/eq}}>Invoiced</option>
              <option value="ignore" {{#eq order.payment_status 'ignore'}}selected="true"{{/eq}}>Ignore</option>
              <option value="error" {{#eq order.payment_status 'error'}}selected="true"{{/eq}}>Error</option>
            </select>
          </dd>
        </div>
        <div class="row">
          <dt>Payment Method</dt>
          <dd>
            <select name="payment_method_id">
              <option {{#isNull ../order.payment_method_id}} selected="true"{{/isNull}}>Invoiced</option>
              {{#notNull order.payment_method_id}}
              {{#unless (contains (pluck ../order.user.payment_methods "id") ../order.payment_method_id) }}
              <option value="{{../../order.payment_method_id}}" selected="true">Removed Payment Method</option>
              {{/unless}}
              {{/notNull}}
              {{#each order.user.payment_methods}}
              <option value="{{id}}" {{#eq ../../order.payment_method_id id~}} selected="true"{{~/eq}}>{{capitalize data.brand}} - {{name}} **** **** **** {{data.last4}} - Exp {{data.exp_month}}/{{data.exp_year}}</option>
              {{/each}}
            </select>
          </dd>
        </div>
        <div class="row">
          <dt>Options</dt>
          <dd>
            {{#unless order.restaurant.plan}}
              <div>
                <input
                  type="checkbox"
                  name="waive_transaction_fee"
                  id="waive_transaction_fee"
                  {{#if order.waive_transaction_fee}}checked{{/if}}>
                <label class="checkbox-label" for="waive_transaction_fee">Waive Transaction Fee</label>
              </div>
            {{/unless}}
            <div>
              <input
                type="checkbox"
                name="waive_delivery_fee"
                id="waive_delivery_fee"
                {{#if order.waive_delivery_fee}}checked{{/if}}>
              <label class="checkbox-label" for="waive_delivery_fee">Waive Delivery Fee</label>
            </div>
          </dd>
        </div>
      </dl>
      <dl class="order-payment-details definition-row-list">
        <div class="title">
          &nbsp;
        </div>
        {{#if order.restaurant.minimum_order}}
          <div class="row minimum-order-row">
            <dt>Minimum Order</dt>
            <dd>${{dollars order.restaurant.minimum_order}}</dd>
          </div>
        {{/if}}
        <div class="row">
          <dt>Subtotal</dt>
          <dd>${{dollars order.sub_total}}</dd>
        </div>
        <div class="row">
          <dt>Delivery Fee</dt>
          <dd>${{dollars order.delivery_fee}}</dd>
        </div>
        <div class="row">
          <dt>Tax</dt>
          <dd>${{dollars order.sales_tax}}</dd>
        </div>
        <div class="row">
          <dt>Tip ({{calcTipPercent order.tip order.sub_total}})</dt>
          <dd>
            ${{dollars order.tip}}
          </dd>
        </div>
        <div class="row order-total-row">
          <dt>Total</dt>
          <dd>
            ${{dollars order.total}}
          </dd>
        </div>
      </dl>
    </section>
  </div>

  <div class="panel-section">
    <section class="panel-component" id="order-user">
      <h1 class="component-title">User #{{order.user.id}}</h1>
      <div class="component-actions">
        {{!-- Edit User --}}
        <div class="component-action">
          <a href="/admin/users/{{order.user.id}}" target="_blank" class="btn btn-white">Edit</a>
        </div>
        {{!-- Change User --}}
        <div class="component-action">
          <span class="popover-wrapper right" id="user-selector">
            <button data-role="popover" data-target="dropdown-popover" class="btn btn-default btn-dropdown">
              Change
              <i class="gb-icon-caret-down"></i>
            </button>
            <div class="popover-modal dropdown-popover">
              <div class="popover-header">&nbsp;
                <a href="#" class="popover-close-btn gb-icon-x-mark pull-right" data-toggle-role="close"></a>
              </div>
              <div class="popover-filter"
                data-role="filter-list"
                data-input="> input"
                data-target="+ .popover-body > .popover-item"
                data-fields="name,id,organization">

                <input type="text" placeholder="Filter...">
              </div>
              <div class="popover-body">
                {{#each users}}
                <a
                  href="#"
                  class="popover-item"
                  data-name="{{this.name}}"
                  data-organization="{{this.organization}}"
                  data-id="{{this.id}}">
                  <span class="popover-item-label">{{this.name}}{{#if this.organization}} - {{this.organization}}{{/if}}</span>
                </a>
                {{/each}}
              </div>
            </div>
          </span>
        </div>
      </div>
      <dl class="user-profile definition-row-list">
        <div class="row">
          <dt>Name</dt>
          <dd>
            {{#if order.user.name}}
              {{order.user.name}}
            {{else}}
              N/A
            {{/if}}
          </dd>
        </div>
        <div class="row">
          <dt>Contact</dt>
          <dd>
            <div>
              {{#if order.contact_phone}}
                <i class="gb-icon-phone"></i> {{phoneNumber order.phone}}
              {{/if}}
            </div>
            <div>
              {{#if order.secondary_contact_phone}}
                <i class="gb-icon-phone"></i> {{phoneNumber order.secondary_contact_phone}}
              {{/if}}
            </div>
          </dd>
        </div>
        <div class="row">
          <dt>Email</dt>
          <dd><i class="gb-icon-email"></i> {{{mailto order.user.email}}}</dd>
        </div>
        <div class="row">
          <dt>Organization</dt>
          <dd>
            {{#if order.user.organization}}
              {{order.user.organization}}
            {{else}}
              N/A
            {{/if}}
          </dd>
        </div>
        <div class="row">
          <dt>Stripe Id</dt>
          <dd>
            {{#if order.user.stripe_id}}
              <a href="https://dashboard.stripe.com/customers/{{order.stripe_id}}" target="_blank">{{order.user.stripe_id}}</a>
            {{else}}
              N/A
            {{/if}}
          </dd>
        </div>
      </dl>
      <dl class="user-profile-more definition-row-list">
        <div class="title">
          More Info
        </div>
        <div class="row">
          <dt>Total Points</dt>
          <dd>
            {{#if order.user.points}}
              {{order.user.points}}
            {{else}}
              N/A
            {{/if}}
          </dd>
        </div>
        <div class="row">
          <dt>Priority Account Rate</dt>
          <dd>
            {{#if order.user.priority_account_price_hike_percentage}}
              {{formatPercent order.user.priority_account_price_hike_percentage}}
            {{else}}
              N/A
            {{/if}}
          </dd>
        </div>
        <div class="row">
          <dt>Default Zip</dt>
          <dd>
            {{#if order.user.default_zip}}
              {{order.user.default_zip}}
            {{else}}
              None Saved
            {{/if}}
          </dd>
        </div>
        <div class="row">
          <dt>Is Invoiced</dt>
          <dd>
            {{#if order.user.is_invoiced}}
              Yes
            {{else}}
              No
            {{/if}}
          </dd>
        </div>
        <div class="row">
          <dt>Is Tax Exempt</dt>
          <dd>
            {{#if order.user.is_tax_exempt}}
              Yes
            {{else}}
              No
            {{/if}}
          </dd>
        </div>
      </dl>
    </section>

    <section class="panel-component" id="order-restaurant">
      <h1 class="component-title">Restaurant #{{order.restaurant.id}}</h1>
      <div class="component-actions">
        {{!-- Edit Restaurant --}}
        <div class="component-action">
          <a class="btn btn-white" href="/admin/restaurants/{{order.restaurant.id}}/basic-info" target="_blank">Edit</a>
        </div>
        {{!-- Change Restaurant --}}
        <div class="component-action">
          <span class="popover-wrapper right" id="restaurant-selector">
            <button data-role="popover" data-target="dropdown-popover" class="btn btn-default btn-dropdown">
              Change
              <i class="gb-icon-caret-down"></i>
            </button>
            <div class="popover-modal dropdown-popover">
              <div class="popover-header">&nbsp;
                <a href="#" class="popover-close-btn gb-icon-x-mark pull-right" data-toggle-role="close"></a>
              </div>
              <div class="popover-filter"
                data-role="filter-list"
                data-input="> input"
                data-target="+ .popover-body > .popover-item"
                data-fields="name,id">

                <input type="text" placeholder="Filter...">
              </div>
              <div class="popover-body">
                {{#each restaurants}}
                <a href="#" class="popover-item" data-name="{{this.name}}" data-id="{{this.id}}">
                  <span class="popover-item-label">{{name}}</span>
                </a>
                {{/each}}
              </div>
            </div>
          </span>
        </div>
      </div>
      <dl class="restaurant-info definition-row-list">
        <div class="row">
          <dt>Name</dt>
          <dd>
            {{#if order.restaurant.name}}
              {{order.restaurant.name}}
            {{else}}
              N/A
            {{/if}}
          </dd>
        </div>
        <div class="row">
          <dt>Address</dt>
          <dd>
            {{{address order.restaurant}}}
          </dd>
        </div>
        <div class="row">
          <dt>Websites</dt>
          <dd>
            {{#if order.restaurant.websites}}
              {{#each order.restaurant.websites}}
                <div>
                  <a href="{{this}}" target="_blank">{{this}}</a>
                </div>
              {{/each}}
            {{else}}
              N/A
            {{/if}}
          </dd>
        </div>
      </dl>
      <dl class="restaurant-info-phones definition-row-list">
        <div class="title">
          Contacts
        </div>
        <div class="row">
          <dt>Display Phone</dt>
          <dd>
            {{#if order.restaurant.display_phone}}
              <i class="gb-icon-phone"></i> {{phoneNumber order.restaurant.display_phone}}
            {{else}}
              N/A
            {{/if}}
          </dd>
        </div>
        {{#each order.restaurant.contacts}}
          <div class="row">
            <dt>Contact #{{index @index}}</dt>
            <dd>
              <div>{{this.name}}</div>
              {{#if this.voice_phones}}
                {{#each this.voice_phones}}
                <div>
                  <i class="gb-icon-phone"></i> {{phoneNumber this}} (voice)
                </div>
                {{/each}}
              {{/if}}
              {{#if this.sms_phones}}
                {{#each this.sms_phones}}
                <div>
                  <i class="gb-icon-phone"></i> {{phoneNumber this}} (text)
                </div>
                {{/each}}
              {{/if}}
              {{#if this.emails}}
                {{#each this.emails}}
                <div>
                  <i class="gb-icon-email"></i> {{{mailto this}}}
                </div>
                {{/each}}
              {{/if}}
            </dd>
          </div>
        {{/each}}
      </dl>
      <dl class="restaurant-info-more definition-row-list">
        <div class="title">
          More Info
        </div>
        <div class="row">
          <dt>Contracted</dt>
          <dd>
            {{#if order.restaurant.has_contract}}
              Yes
            {{else}}
              No {{#if order.restaurant.no_contract_fee}}, {{formatPercent order.restaurant.no_contract_fee}} fee{{/if}}
            {{/if}}
          </dd>
        </div>
        <div class="row">
          <dt>GB Fee</dt>
          <dd>
            {{#if order.restaurant.gb_fee}}
              {{formatPercent order.restaurant.gb_fee}}
            {{else}}
              0%
            {{/if}}
          </dd>
        </div>
        <div class="row">
          <dt>Courier Disabled</dt>
          <dd>
            {{#if order.restaurant.disable_courier}}
              Yes
            {{else}}
              No
            {{/if}}
          </dd>
        </div>
        <div class="row">
          <dt>Courier Notifications Disabled</dt>
          <dd>
            {{#if order.restaurant.disable_courier_notifications}}
              Yes
            {{else}}
              No
            {{/if}}
          </dd>
        </div>
        <div class="row">
          <dt>Accepts Tips</dt>
          <dd>
            {{#if order.restaurant.accepts_tips}}
              Yes
            {{else}}
              No
            {{/if}}
          </dd>
        </div>
      </dl>
    </section>
  </div>

  <div class="panel-section">
    <section class="panel-component" id="order-pdfs">
      <div class="pdf-previews">
        <div class="pdf-preview" data-order-id="{{order.id}}" data-type="receipt">
          <div class="pdf-preview-header">
            <h3 class="component-title">Receipt</h3>
            <ul class="nav nav-tabs nav-tabs-sm">
              <li>
                <a href="#" class="rebuild-pdf">Re-Build PDF</a>
              </li>
              <li>
                <a href="#" class="refresh">Refresh</a>
              </li>
              <li>
                <a href="{{config.baseUrl}}/receipts/order-{{order.id}}.pdf" target="_blank">View</a>
              </li>
            </ul>
          </div>
          <div class="pdf-preview-alert"></div>
          <div>
            <div class="catch-mouse-overlay"></div>
            <iframe src="{{config.baseUrl}}/receipts/order-{{order.id}}.pdf" frameborder="0"></iframe>
          </div>
        </div>
        <div class="pdf-preview" data-order-id="{{order.id}}" data-type="manifest">
          <div class="pdf-preview-header">
            <h3 class="component-title">Manifest</h3>
            <ul class="nav nav-tabs nav-tabs-sm">
              <li>
                <a href="#" class="rebuild-pdf">Re-Build PDF</a>
              </li>
              <li>
                <a href="#" class="refresh">Refresh</a>
              </li>
              <li>
                <a href="{{config.baseUrl}}/manifests/manifest-{{order.id}}.pdf" target="_blank">View</a>
              </li>
            </ul>
          </div>
          <div class="pdf-preview-alert"></div>
          <div>
            <div class="catch-mouse-overlay"></div>
            <iframe src="{{config.baseUrl}}/manifests/manifest-{{order.id}}.pdf" frameborder="0"></iframe>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="panel-section">
    <section class="panel-component" id="order-directions">
      <h1 class="component-title">Directions</h1>
      <div>
        <div class="catch-mouse-overlay"></div>
        {{{directions order.location order}}}
      </div>
    </section>
  </div>

  <div class="panel-section">
    <section class="panel-component" id="order-notifications">
      <h1 class="component-title">Notifications</h1>
      <ul class="component-nav nav nav-tabs">
        <li class="active">
          <a href="#notifications-history" data-toggle="tab">History</a>
        </li>
        <li>
          <a href="#notifications-available" data-toggle="tab">Available</a>
        </li>
      </ul>
      <div class="tab-content">
        <div class="tab-pane active" id="notifications-history">
          <table class="table notifications-table" id="notifications-history-table"></table>
        </div>

        <div class="tab-pane" id="notifications-available">
          <table class="table notifications-table" id="notifications-table"></table>
        </div>
      </div>
    </section>
  </div>

  <section class="panel-component" id="order-revisions-timeline">
    <h1 class="component-title">Revision Timeline</h1>
    <div class="panel-body">
      <table class="table">
        <tr>
          <th>User</th>
          <th>Description</th>
          <th>Date Occured</th>
        </tr>

        {{#each order.revisions}}
        <tr>
          <td>
            {{#if this.actor_id}}
              <a href="/admin/users/{{this.actor_id}}">#{{this.actor_id}}</a> {{this.actor_name}}
            {{else}}
              Unknown
            {{/if}}
          </td>
          <td>
            {{this.description}}
            {{#if this.details.order_item}}
              <div class="item-card-tooltip">
                (<div class="item-card-tooltip-text">{{this.details.order_item.name}}</div>)

                <div class="item-card-tooltip-card">
                  {{> timeline_order_item_description this.details.order_item}}
                </div>
              </div>
            {{/if}}
          </td>
          <td>{{formatDateTimeWithTz this.created_at req.user.region.timezone "MM/DD/YYYY h:mm A"}}</td>
        </tr>
        {{/each}}
      </table>
    </div>
  </section>
{{/extend}}

{{#extend "scripts"}}
<script>
  require( ['app/pages/admin/order', 'app/models/order'], function( page, Order ){
    page.init({
      order: new Order( {{{json order}}}, {
        ignoreOrderTypeInit: true
      })
    });
  });
</script>
{{/extend}}
