{{#extend "css"}}
<link rel="stylesheet" href="/css/menu.css">
{{/extend}}

<div class="page page-menu">
  <div class="row">
    <div class="col-lg-12">{{> order_params_bar}}</div>
  </div>

  <div class="row">
    <h1 class="col-lg-12 page-title">{{restaurant.name}}</h1>
  </div>

  <div class="row">
    <div class="col-md-8">
      <div class="menu">
        {{#each restaurant.categories}}
        <div class="panel menu-category">
          <div class="panel-heading menu-cateogry-heading">
            <h3 class="panel-title menu-cateogry-title">{{name}}</h3>
          </div>
          <div class="list-group list-group-flush category" id="category-{{id}}">
            {{#each items}}
            <a class="list-group-item item" id="item-{{id}}">
              <h5 class="list-group-item-heading">{{name}}</h5>
              <p class="list-group-item-text">{{description}}</p>
              <dl class="item-legend list-item-legend">
                <dt>Feeds</dt>
                <dd>{{feeds_min}}-{{feeds_max}}</dd>
                <dt>Price</dt>
                <dd>{{dollars price}}</dd>
              </dl>
            </a>
            {{/each}}
          </div>
        </div>
        {{/each}}
      </div>
    </div>

  <div class="col-md-4">
    <div class="panel order-summary" data-spy="affix" data-offset-top="174">
      <div class="panel-heading">
        <h2 class="panel-title">Your Order</h2>
      </div>

      {{> order_summary}}
    </div>
  </div>

  <div class="modal fade modal-item" id="item-modal" role="dialog" aria-labelledby="itemModal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <div class="row">
            <h4 class="modal-title col-sm-8"></h4>
            <div class="col-sm-4 item-legend-wrapper">
              <dl class="item-legend">
                <dt>Feeds</dt>
                <dd class="item-legend-detail-feeds"></dd>
                <dt>Price</dt>
                <dd class="item-legend-detail-price"></dd>
              </dl>
            </div>
          </div>
        </div>
        <div class="modal-body">
          <p class="item-description"></p>
        </div>
        <div class="modal-footer">
          <div class="row modal-footer-actions">
            <div class="col-xs-6 modal-footer-left-actions">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              <button class="btn btn-warning btn-item-remove">Remove from Order</button>
            </div>
            <div class="col-xs-6 modal-footer-right-actions">
              <form class="modal-item-form form-inline">
                <div class="form-group">
                  <label class="control-label col-lg-2" for="item-modal-quantity">Quantity</label>
                </div>
                <div class="form-group">
                  <input type="number" class="form-control item-quantity col-lg-1" id="item-modal-quantity" maxlength="4" min="0" />
                </div>
                <div class="form-group">
                  <button type="submit" class="btn btn-primary item-modal-submit">Add to order</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade modal-order-params" id="order-params-modal" role="dialog" aria-labelledby="orderParamsRequiredModal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">All info must be entered before creating an order</h4>
        </div>
        <div class="modal-body">
          <div class="order-params-wrapper">
            {{> order_params_bar}}
          </div>
          <div class="alert alert-danger hide">You must fill out all fields</div>
        </div>
        <div class="modal-footer">
          <div class="btn-toolbar pull-right">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary btn-submit">Submit</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{{#extend "scripts"}}
<script>
  var partials = {order_item_summary: 'order-item-summary.hbs', item_modal_title: 'item-modal-title.hbs'};
  for (var name in partials) {
    $.ajax({
      type: 'GET',
      url: '/partials/' + partials[name],
      success: function(data, textStatus, jqXHR) {
        Handlebars.registerPartial(name, Handlebars.compile(data));
      },
      dataType: 'html',
      async: false
    });
  }
</script>

<script type="text/javascript" src="/js/models/order-item.js"></script>
<script src="/js/models/order.js"></script>
<script type="text/javascript" src="/js/models/order-params.js"></script>

<script type="text/javascript" src="/js/views/order-item-summary-view.js"></script>
<script type="text/javascript" src="/js/views/order-summary-view.js"></script>
<script type="text/javascript" src="/js/views/order-params-view.js"></script>
<script type="text/javascript" src="/js/views/item-view.js"></script>
<script type="text/javascript" src="/js/views/item-modal.js"></script>
<script type="text/javascript" src="/js/views/order-params-modal.js"></script>

<script>
  var orderParams = new OrderParams({{{json orderParams}}});
  var orderParamsView = new OrderParamsView({model: orderParams, el: '.order-params-bar'});
  var orderParamsModal = new OrderParamsModal({model: orderParams, el: '#order-params-modal', loginNeeded: {{#if user.id}}false{{else}}true{{/if}}, orderParamsNeeded: !{{{json orderParams.complete}}} });

  var orderModel = new Order( {{{json order}}} );

  var itemModalView = new ItemModal({el: '#item-modal', orderItems: orderModel.orderItems});

  var orderView = new OrderSummaryView({el: '.order-summary', model: orderModel, itemModalView: itemModalView});

  {{#each order.orderItems}}
  new OrderItemSummaryView({el: '#order-item-{{id}}', model: orderModel.orderItems.get({{id}}), itemModalView: itemModalView});
  {{/each}}

  var itemViews = [
    {{#each restaurant.categories}}
    {{#each items}}
    new ItemView({
      el: $('#item-{{id}}'),
      model: new Backbone.Model( {{{json this}}} ),
      itemModalView: itemModalView,
      orderParamsModal: orderParamsModal
      }),
    {{/each}}
    {{/each}}
  ];

</script>
{{/extend}}
